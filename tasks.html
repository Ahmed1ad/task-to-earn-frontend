<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>Ø§Ù„Ù…Ù‡Ø§Ù… | TaskToEarn</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Main JS (Auth + API base) -->
  <script src="main.js" defer></script>
</head>

<body class="bg-gray-100 min-h-screen flex flex-col">

<!-- ================= HEADER ================= -->
<header class="bg-white shadow sticky top-0 z-40">
  <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">

    <!-- Right -->
    <div class="flex items-center gap-3">
      <button class="text-2xl">â˜°</button>
      <span class="font-bold text-lg">TaskToEarn</span>
    </div>

    <!-- Left -->
    <div class="flex items-center gap-3">
      <span id="userPoints"
        class="bg-green-100 text-green-700 px-3 py-1 rounded-full text-sm">
        0 Ù†Ù‚Ø·Ø©
      </span>
      <img
        src="https://ui-avatars.com/api/?name=User"
        class="w-9 h-9 rounded-full cursor-pointer"
      />
    </div>

  </div>
</header>

<!-- ================= CONTENT ================= -->
<main class="flex-1 max-w-6xl mx-auto w-full px-4 py-6">

  <!-- Tabs -->
  <div class="flex gap-2 mb-6">
    <button id="tabAvailable"
      class="flex-1 py-2 rounded-xl bg-green-500 text-white font-medium">
      Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ù…ØªØ§Ø­Ø©
    </button>
    <button id="tabCompleted"
      class="flex-1 py-2 rounded-xl bg-gray-200 font-medium">
      Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©
    </button>
  </div>

  <!-- Tasks Container -->
  <div id="tasksContainer" class="grid gap-4 sm:grid-cols-2 lg:grid-cols-3">
    <!-- tasks here -->
  </div>

</main>

<!-- ================= MODAL ================= -->
<div id="taskModal"
  class="fixed inset-0 bg-black/60 hidden items-center justify-center z-50">

  <div class="bg-white w-full max-w-md rounded-2xl overflow-hidden">

    <!-- Modal Header -->
    <div class="flex items-center justify-between px-4 py-3 bg-gray-100">
      <span class="font-bold">
        Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ:
        <span id="timer" class="text-red-500">0</span> Ø«
      </span>
      <button onclick="failTask()" class="text-red-500 text-xl">âœ•</button>
    </div>

    <!-- Ad -->
    <iframe id="adFrame" class="w-full h-80 border-none"></iframe>

    <!-- Footer -->
    <div class="p-4">
      <button id="completeBtn"
        onclick="completeTask()"
        disabled
        class="w-full py-3 rounded-xl bg-gray-300 text-white font-bold">
        Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ù…Ù‡Ù…Ø©
      </button>
    </div>

  </div>
</div>

<!-- ================= SCRIPT ================= -->
<script>
/* ================= CONFIG ================= */
const API = "https://task-to-earn.onrender.com";
const token = localStorage.getItem("token");

let currentTask = null;
let timerInterval = null;
let secondsLeft = 0;

/* ================= LOAD USER ================= */
async function loadUser() {
  const res = await fetch(API + "/auth/check", {
    headers: { Authorization: "Bearer " + token }
  });
  const data = await res.json();

  if (data.status === "success") {
    document.getElementById("userPoints").innerText =
      data.user.points + " Ù†Ù‚Ø·Ø©";
  }
}

/* ================= LOAD TASKS ================= */
async function loadAvailableTasks() {
  setActiveTab("available");
  showSkeleton();

  const res = await fetch(API + "/tasks/ads", {
    headers: { Authorization: "Bearer " + token }
  });
  const data = await res.json();

  if (!data.tasks || data.tasks.length === 0) {
    showEmpty("Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù‡Ø§Ù… Ù…ØªØ§Ø­Ø© Ø­Ø§Ù„ÙŠÙ‹Ø§");
    return;
  }

  document.getElementById("tasksContainer").innerHTML =
    data.tasks.map(taskCard).join("");
}

async function loadCompletedTasks() {
  setActiveTab("completed");
  showSkeleton();

  const res = await fetch(API + "/tasks/my?status=completed", {
    headers: { Authorization: "Bearer " + token }
  });
  const data = await res.json();

  if (!data.tasks || data.tasks.length === 0) {
    showEmpty("Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù‡Ø§Ù… Ù…ÙƒØªÙ…Ù„Ø©");
    return;
  }

  document.getElementById("tasksContainer").innerHTML =
    data.tasks.map(completedCard).join("");
}

/* ================= TASK FLOW ================= */
async function startTask(task) {
  currentTask = task;

  await fetch(API + `/tasks/ads/start/${task.id}`, {
    method: "POST",
    headers: { Authorization: "Bearer " + token }
  });

  secondsLeft = task.duration_seconds;
  document.getElementById("timer").innerText = secondsLeft;
  document.getElementById("completeBtn").disabled = true;
  document.getElementById("completeBtn").className =
    "w-full py-3 rounded-xl bg-gray-300 text-white font-bold";

  document.getElementById("adFrame").src = task.ad_url;
  document.getElementById("taskModal").classList.remove("hidden");
  document.getElementById("taskModal").classList.add("flex");

  timerInterval = setInterval(() => {
    secondsLeft--;
    document.getElementById("timer").innerText = secondsLeft;

    if (secondsLeft <= 0) {
      clearInterval(timerInterval);
      document.getElementById("completeBtn").disabled = false;
      document.getElementById("completeBtn").className =
        "w-full py-3 rounded-xl bg-green-500 text-white font-bold";
    }
  }, 1000);
}

async function completeTask() {
  await fetch(API + `/tasks/ads/complete/${currentTask.id}`, {
    method: "POST",
    headers: { Authorization: "Bearer " + token }
  });

  closeModal();
  loadAvailableTasks();
  loadUser();
}

function failTask() {
  closeModal();
}

function closeModal() {
  clearInterval(timerInterval);
  document.getElementById("adFrame").src = "";
  document.getElementById("taskModal").classList.add("hidden");
  document.getElementById("taskModal").classList.remove("flex");
}

/* ================= UI HELPERS ================= */
function taskCard(t) {
  return `
  <div class="bg-white rounded-2xl shadow p-4 flex flex-col">
    <h3 class="font-bold mb-1">${t.title}</h3>
    <p class="text-sm text-gray-500 mb-3">${t.description}</p>

    <div class="flex justify-between text-sm mb-4">
      <span>â± ${t.duration_seconds} Ø«</span>
      <span>ğŸ ${t.reward_points} Ù†Ù‚Ø·Ø©</span>
    </div>

    <button
      onclick='startTask(${JSON.stringify(t)})'
      class="mt-auto py-2 rounded-xl bg-green-500 text-white font-bold">
      Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù…Ù‡Ù…Ø©
    </button>
  </div>`;
}

function completedCard(t) {
  return `
  <div class="bg-white rounded-2xl shadow p-4 opacity-70">
    <h3 class="font-bold">${t.title}</h3>
    <span class="text-green-600 text-sm">âœ” Ù…ÙƒØªÙ…Ù„Ø©</span>
  </div>`;
}

function showSkeleton() {
  document.getElementById("tasksContainer").innerHTML = `
    <div class="h-32 bg-gray-200 rounded-xl animate-pulse"></div>
    <div class="h-32 bg-gray-200 rounded-xl animate-pulse"></div>
    <div class="h-32 bg-gray-200 rounded-xl animate-pulse"></div>
  `;
}

function showEmpty(text) {
  document.getElementById("tasksContainer").innerHTML = `
    <div class="col-span-full text-center text-gray-500 mt-10">
      ${text}
    </div>
  `;
}

function setActiveTab(tab) {
  document.getElementById("tabAvailable").className =
    tab === "available"
      ? "flex-1 py-2 rounded-xl bg-green-500 text-white font-medium"
      : "flex-1 py-2 rounded-xl bg-gray-200 font-medium";

  document.getElementById("tabCompleted").className =
    tab === "completed"
      ? "flex-1 py-2 rounded-xl bg-green-500 text-white font-medium"
      : "flex-1 py-2 rounded-xl bg-gray-200 font-medium";
}

/* ================= EVENTS ================= */
document.getElementById("tabAvailable").onclick = loadAvailableTasks;
document.getElementById("tabCompleted").onclick = loadCompletedTasks;

/* ================= INIT ================= */
loadUser();
loadAvailableTasks();
</script>

</body>
</html>