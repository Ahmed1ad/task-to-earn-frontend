<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>Ø§Ù„Ù…Ù‡Ø§Ù… | TaskToEarn</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Main JS (Auth + API base) -->
  <script src="main.js" defer></script>
</head>

<body class="bg-gradient-to-br from-green-50 to-emerald-100 min-h-screen">

<!-- ================= HEADER ================= -->
<header class="fixed top-0 w-full bg-white shadow z-50">
  <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">

    <!-- Menu -->
    <button id="menuBtn" class="text-2xl">â˜°</button>

    <!-- Points -->
    <div class="flex items-center gap-2 bg-emerald-100 px-3 py-1 rounded-full">
      ğŸª™ <span id="userPoints" class="font-bold">0</span>
    </div>

    <!-- Profile -->
    <div class="relative">
      <button id="profileBtn"
        class="w-10 h-10 rounded-full bg-gray-300 flex items-center justify-center">
        ğŸ‘¤
      </button>

      <!-- Profile Dropdown -->
      <div id="profileMenu"
        class="hidden absolute left-0 mt-2 w-40 bg-white rounded-xl shadow p-2">
        <button class="w-full text-right px-3 py-2 hover:bg-gray-100 rounded">
          Ø­Ø³Ø§Ø¨ÙŠ
        </button>
        <button class="w-full text-right px-3 py-2 hover:bg-gray-100 rounded">
          Ø§Ù„Ø³Ø­Ø¨
        </button>
        <button onclick="logout()"
          class="w-full text-right px-3 py-2 hover:bg-red-100 text-red-600 rounded">
          ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬
        </button>
      </div>
    </div>

  </div>
</header>


<!-- ================= Sidebar ================= -->
<aside id="sidebar"
  class="fixed top-16 right-0 w-64 h-[calc(100%-4rem)] bg-white shadow-lg
         transform translate-x-full transition z-50">

  <div class="p-4 border-b flex justify-between items-center font-bold">
    <span>Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</span>
    <button onclick="closeSidebar()" class="text-xl">âœ•</button>
  </div>

  <nav class="p-4 flex flex-col gap-3 text-sm">
    <a href="home.html" class="p-3 hover:bg-gray-100 rounded-xl">ğŸ  Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
    <a href="tasks.html" class="p-3 bg-emerald-100 rounded-xl">ğŸ“‹ Ø§Ù„Ù…Ù‡Ø§Ù…</a>
    <a href="#" class="p-3 hover:bg-gray-100 rounded-xl">ğŸ’° Ø§Ù„Ø³Ø­Ø¨</a>
    <a href="#" class="p-3 hover:bg-gray-100 rounded-xl">ğŸ§¾ Ø§Ù„Ø³Ø¬Ù„</a>
  </nav>
</aside>

<div id="overlay" class="fixed inset-0 bg-black/40 hidden z-40"></div>

<!-- ================= CONTENT ================= -->
<main class="flex-1 max-w-6xl mx-auto w-full px-4 pt-24 pb-6">

  <!-- Tabs -->
  <div class="flex gap-2 mb-6">
    <button id="tabAvailable"
      class="flex-1 py-2 rounded-xl bg-green-500 text-white font-medium">
      Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ù…ØªØ§Ø­Ø©
    </button>
    <button id="tabCompleted"
      class="flex-1 py-2 rounded-xl bg-gray-200 font-medium">
      Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©
    </button>
  </div>

  <!-- Tasks -->
  <div id="tasksContainer" class="grid gap-4 sm:grid-cols-2 lg:grid-cols-3">
    <!-- tasks here -->
  </div>

</main>

<!-- ================= MODAL ================= -->
<div id="taskModal"
  class="fixed inset-0 bg-black/60 hidden items-center justify-center z-50">

  <div class="bg-white w-full max-w-md rounded-2xl overflow-hidden">

    <div class="flex items-center justify-between px-4 py-3 bg-gray-100">
      <span class="font-bold text-sm">
        Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ:
        <span id="timer" class="text-red-500">0</span> Ø«
      </span>
      <button onclick="failTask()" class="text-red-500 text-xl">âœ•</button>
    </div>

    <iframe id="adFrame" class="w-full h-80 border-none"></iframe>

    <div class="p-4">
      <button id="completeBtn"
        onclick="completeTask()"
        disabled
        class="w-full py-3 rounded-xl bg-gray-300 text-white font-bold transition">
        Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ù…Ù‡Ù…Ø©
      </button>
    </div>

  </div>
</div>

<!-- ================= SCRIPT ================= -->
<script>
/* ================= CONFIG ================= */
const API = "https://task-to-earn.onrender.com";
const token = localStorage.getItem("token");

let currentTask = null;
let timerInterval = null;
let secondsLeft = 0;

/* ================= LOAD USER ================= */
async function loadUser() {
  const res = await fetch(API + "/auth/check", {
    headers: { Authorization: "Bearer " + token }
  });
  const data = await res.json();
  if (data.status === "success") {
    document.getElementById("userPoints").innerText = data.user.points;
  }
}

/* ================= LOAD TASKS ================= */
async function loadAvailableTasks() {
  setActiveTab("available");
  showSkeleton();

  const res = await fetch(API + "/tasks/ads", {
    headers: { Authorization: "Bearer " + token }
  });
  const data = await res.json();

  if (!data.tasks || data.tasks.length === 0) {
    showEmpty("Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù‡Ø§Ù… Ù…ØªØ§Ø­Ø© Ø­Ø§Ù„ÙŠÙ‹Ø§");
    return;
  }

  document.getElementById("tasksContainer").innerHTML =
    data.tasks.map(taskCard).join("");
}

async function loadCompletedTasks() {
  setActiveTab("completed");
  showSkeleton();

  const res = await fetch(API + "/tasks/my?status=completed", {
    headers: { Authorization: "Bearer " + token }
  });
  const data = await res.json();

  if (!data.tasks || data.tasks.length === 0) {
    showEmpty("Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù‡Ø§Ù… Ù…ÙƒØªÙ…Ù„Ø©");
    return;
  }

  document.getElementById("tasksContainer").innerHTML =
    data.tasks.map(completedCard).join("");
}

/* ================= TASK FLOW ================= */
async function startTask(task) {
  currentTask = task;

  await fetch(API + `/tasks/ads/start/${task.id}`, {
    method: "POST",
    headers: { Authorization: "Bearer " + token }
  });

  localStorage.setItem("activeTask", JSON.stringify({
  taskId: task.id,
  startTime: Date.now(),
  duration: task.duration_seconds
}));

  secondsLeft = task.duration_seconds;
  document.getElementById("timer").innerText = secondsLeft;
  document.getElementById("completeBtn").disabled = true;
  document.getElementById("completeBtn").className =
    "w-full py-3 rounded-xl bg-gray-300 text-white font-bold";

  window.open(task.ad_url, "_blank");
  document.getElementById("taskModal").classList.remove("hidden");
  document.getElementById("taskModal").classList.add("flex");

  timerInterval = setInterval(() => {
    secondsLeft--;
    document.getElementById("timer").innerText = secondsLeft;

    if (secondsLeft <= 0) {
      clearInterval(timerInterval);
      document.getElementById("completeBtn").disabled = false;
      document.getElementById("completeBtn").className =
        "w-full py-3 rounded-xl bg-green-500 text-white font-bold hover:bg-green-600";
    }
  }, 1000);
}

async function completeTask() {
  await fetch(API + `/tasks/ads/complete/${currentTask.id}`, {
    method: "POST",
    headers: { Authorization: "Bearer " + token }
  });

  localStorage.removeItem("activeTask");

  closeModal();
  loadAvailableTasks();
  loadUser();
}

  
async function failTask() {
  if (currentTask) {
    await fetch(`${API}/tasks/ads/fail/${currentTask.id}`, {
      method: "POST",
      headers: { Authorization: "Bearer " + token }
    });
  }
  closeModal();
}

function closeModal() {
  clearInterval(timerInterval);
  document.getElementById("adFrame").src = "";
  document.getElementById("taskModal").classList.add("hidden");
  document.getElementById("taskModal").classList.remove("flex");
}

/* ================= UI HELPERS ================= */
function taskCard(t) {
  return `
  <div class="bg-white rounded-2xl shadow p-4 flex flex-col">
    <h3 class="font-bold mb-1">${t.title}</h3>
    <p class="text-sm text-gray-500 mb-3">${t.description}</p>

    <div class="flex justify-between text-sm mb-4">
      <span>â± ${t.duration_seconds} Ø«</span>
      <span>ğŸ ${t.reward_points} Ù†Ù‚Ø·Ø©</span>
    </div>

    <button
      onclick='startTask(${JSON.stringify(t)})'
      class="mt-auto py-2 rounded-xl bg-green-500 text-white font-bold
             hover:bg-green-600 active:scale-95 transition">
      Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù…Ù‡Ù…Ø©
    </button>
  </div>`;
}

function completedCard(t) {
  return `
  <div class="bg-white rounded-2xl shadow p-4 flex flex-col gap-2 opacity-80">

    <h3 class="font-bold text-lg">${t.title}</h3>

    <div class="flex items-center justify-between text-sm">
      <span class="text-green-600 font-medium">âœ” Ù…ÙƒØªÙ…Ù„Ø©</span>
      <span class="text-emerald-600 font-bold">
        +${t.reward_points} Ù†Ù‚Ø·Ø©
      </span>
    </div>

  </div>`;
}

function showSkeleton() {
  document.getElementById("tasksContainer").innerHTML = `
    <div class="h-32 bg-gray-200 rounded-xl animate-pulse"></div>
    <div class="h-32 bg-gray-200 rounded-xl animate-pulse"></div>
    <div class="h-32 bg-gray-200 rounded-xl animate-pulse"></div>
  `;
}

function showEmpty(text) {
  document.getElementById("tasksContainer").innerHTML = `
    <div class="col-span-full text-center text-gray-500 mt-10">
      ${text}
    </div>
  `;
}

function setActiveTab(tab) {
  document.getElementById("tabAvailable").className =
    tab === "available"
      ? "flex-1 py-2 rounded-xl bg-green-500 text-white font-medium"
      : "flex-1 py-2 rounded-xl bg-gray-200 font-medium";

  document.getElementById("tabCompleted").className =
    tab === "completed"
      ? "flex-1 py-2 rounded-xl bg-green-500 text-white font-medium"
      : "flex-1 py-2 rounded-xl bg-gray-200 font-medium";
}

/* ================= SIDEBAR ================= */
const menuBtn = document.getElementById("menuBtn");
const sidebar = document.getElementById("sidebar");
const overlay = document.getElementById("overlay");

menuBtn.onclick = () => {
  sidebar.classList.remove("translate-x-full");
  overlay.classList.remove("hidden");
};

function closeSidebar() {
  sidebar.classList.add("translate-x-full");
  overlay.classList.add("hidden");
}

overlay.onclick = closeSidebar;

// Profile dropdown
profileBtn.onclick = () => {
  profileMenu.classList.toggle("hidden");
};


// Logout
function logout() {
  localStorage.removeItem("token");
  location.href = "login.html";
}


/* ================= INIT ================= */

(async function init() {

  // 1ï¸âƒ£ ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ø¸Ø± Ø£ÙˆÙ„Ù‹Ø§
  await checkBanStatus();

  // 2ï¸âƒ£ ØªØ­Ù‚Ù‚ Ù…Ù† Ù…Ù‡Ù…Ø© Ù†Ø´Ø·Ø© Ø³Ø§Ø¨Ù‚Ø©
  const activeTask = localStorage.getItem("activeTask");

  if (activeTask) {
    const task = JSON.parse(activeTask);
    const elapsed = Math.floor((Date.now() - task.startTime) / 1000);

    if (elapsed < task.duration) {
      // âŒ Ø§Ù„Ù…Ù‡Ù…Ø© ÙØ´Ù„Øª
      await fetch(`${API}/tasks/ads/fail/${task.taskId}`, {
        method: "POST",
        headers: {
          Authorization: "Bearer " + token
        }
      });

      alert("âŒ Ø§Ù„Ù…Ù‡Ù…Ø© ÙØ´Ù„ØªØŒ Ø£Ø¹Ø¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©");
    }

    localStorage.removeItem("activeTask");
  }

  // 3ï¸âƒ£ Ø±Ø¨Ø· Ø§Ù„ØªØ§Ø¨Ø§Øª
  document.getElementById("tabAvailable").onclick = loadAvailableTasks;
  document.getElementById("tabCompleted").onclick = loadCompletedTasks;

  // 4ï¸âƒ£ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
  await loadUser();
  await loadAvailableTasks();

})();

  
</script>

</body>
</html>
