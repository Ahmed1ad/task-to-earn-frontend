<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>Ø§Ù„Ù…Ù‡Ø§Ù… | TaskToEarn</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 min-h-screen">

<!-- Header -->
<header class="bg-white shadow flex items-center justify-between px-4 py-3">
  <button id="menuBtn" class="text-2xl">â˜°</button>
  <div class="flex items-center gap-3">
    <span id="points" class="bg-gray-100 px-3 py-1 rounded-full text-sm">0 C</span>
    <div class="w-8 h-8 rounded-full bg-gray-300 cursor-pointer"></div>
  </div>
</header>

<!-- Tabs -->
<div class="flex gap-2 px-4 mt-4">
  <button id="tabAvailable" class="flex-1 bg-green-500 text-white py-2 rounded-lg">Ø§Ù„Ù…Ù‡Ø§Ù…</button>
  <button id="tabCompleted" class="flex-1 bg-gray-200 py-2 rounded-lg">Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©</button>
</div>

<!-- Content -->
<main class="p-4 space-y-4" id="content"></main>

<!-- Ad Modal -->
<div id="adModal" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-50">
  <div class="bg-white w-full max-w-md rounded-xl overflow-hidden">
    <div class="p-3 flex justify-between items-center bg-gray-100">
      <span id="timer" class="font-bold text-red-500">00</span>
      <button onclick="failTask()" class="text-red-500">âœ–</button>
    </div>

    <iframe id="adFrame" class="w-full h-80 border-none"></iframe>

    <div class="p-4">
      <button id="completeBtn"
        onclick="completeTask()"
        disabled
        class="w-full bg-gray-300 text-white py-2 rounded-lg">
        Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ù…Ù‡Ù…Ø©
      </button>
    </div>
  </div>
</div>

<script>
const API = "https://task-to-earn.onrender.com";
const token = localStorage.getItem("token");
if (!token) location.href = "login.html";

let currentTask = null;
let timerInterval = null;
let secondsLeft = 0;

// ---------------- LOAD TASKS ----------------
async function loadAvailable() {
  document.getElementById("content").innerHTML = skeleton();
  const res = await fetch(API + "/tasks/ads", {
    headers: { Authorization: "Bearer " + token }
  });
  const data = await res.json();

  if (!data.tasks.length) {
    document.getElementById("content").innerHTML =
      `<div class="text-center text-gray-500 mt-10">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù‡Ø§Ù… Ù…ØªØ§Ø­Ø© Ø§Ù„Ø¢Ù†</div>`;
    return;
  }

  document.getElementById("content").innerHTML = data.tasks.map(taskCard).join("");
}

async function loadCompleted() {
  document.getElementById("content").innerHTML = skeleton();
  const res = await fetch(API + "/tasks/my?status=completed", {
    headers: { Authorization: "Bearer " + token }
  });
  const data = await res.json();

  if (!data.tasks.length) {
    document.getElementById("content").innerHTML =
      `<div class="text-center text-gray-500 mt-10">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù‡Ø§Ù… Ù…ÙƒØªÙ…Ù„Ø©</div>`;
    return;
  }

  document.getElementById("content").innerHTML = data.tasks.map(taskCardCompleted).join("");
}

// ---------------- TASK FLOW ----------------
async function startTask(task) {
  currentTask = task;

  await fetch(API + `/tasks/ads/start/${task.id}`, {
    method: "POST",
    headers: { Authorization: "Bearer " + token }
  });

  secondsLeft = task.duration_seconds;
  document.getElementById("timer").innerText = secondsLeft;
  document.getElementById("completeBtn").disabled = true;
  document.getElementById("completeBtn").className =
    "w-full bg-gray-300 text-white py-2 rounded-lg";

  document.getElementById("adFrame").src = task.ad_url;
  document.getElementById("adModal").classList.remove("hidden");

  timerInterval = setInterval(() => {
    secondsLeft--;
    document.getElementById("timer").innerText = secondsLeft;

    if (secondsLeft <= 0) {
      clearInterval(timerInterval);
      document.getElementById("completeBtn").disabled = false;
      document.getElementById("completeBtn").className =
        "w-full bg-green-500 text-white py-2 rounded-lg";
    }
  }, 1000);
}

async function completeTask() {
  await fetch(API + `/tasks/ads/complete/${currentTask.id}`, {
    method: "POST",
    headers: { Authorization: "Bearer " + token }
  });

  closeModal();
  loadAvailable();
}

function failTask() {
  closeModal();
}

function closeModal() {
  clearInterval(timerInterval);
  document.getElementById("adFrame").src = "";
  document.getElementById("adModal").classList.add("hidden");
}

// ---------------- UI ----------------
function taskCard(t) {
  return `
  <div class="bg-white rounded-xl p-4 shadow">
    <h3 class="font-bold mb-1">${t.title}</h3>
    <p class="text-sm text-gray-500 mb-2">${t.description}</p>
    <div class="flex justify-between text-sm mb-3">
      <span>â± ${t.duration_seconds} Ø«</span>
      <span>ğŸ ${t.reward_points} Ù†Ù‚Ø·Ø©</span>
    </div>
    <button onclick='startTask(${JSON.stringify(t)})'
      class="w-full bg-green-500 text-white py-2 rounded-lg">
      Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù…Ù‡Ù…Ø©
    </button>
  </div>`;
}

function taskCardCompleted(t) {
  return `
  <div class="bg-white rounded-xl p-4 shadow opacity-70">
    <h3 class="font-bold">${t.title}</h3>
    <span class="text-green-600 text-sm">âœ” Ù…ÙƒØªÙ…Ù„Ø©</span>
  </div>`;
}

function skeleton() {
  return `<div class="animate-pulse bg-gray-200 h-24 rounded-xl"></div>
          <div class="animate-pulse bg-gray-200 h-24 rounded-xl"></div>`;
}

// Tabs
document.getElementById("tabAvailable").onclick = () => {
  loadAvailable();
};
document.getElementById("tabCompleted").onclick = () => {
  loadCompleted();
};

loadAvailable();
</script>
</body>
</html>